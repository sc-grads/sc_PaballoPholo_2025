name: SQL Server Automation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  automate-sql:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Install SQL Server tools
      run: choco install sqlcmd -y
      
    - name: Run SQL scripts
      env:
        SQL_SERVER: ${{ secrets.SQL_SERVER }}
        SQL_USERNAME: ${{ secrets.SQL_USERNAME }}
        SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
      run: |
        sqlcmd -S "$env:SQL_SERVER" -U "$env:SQL_USERNAME" -P "$env:SQL_PASSWORD" -Q "CREATE DATABASE AutoTest"
        sqlcmd -S "$env:SQL_SERVER" -U "$env:SQL_USERNAME" -P "$env:SQL_PASSWORD" -d AutoTest -Q "CREATE TABLE [user] (Name NVARCHAR(100), Surname NVARCHAR(100), Email NVARCHAR(100))"
        sqlcmd -S "$env:SQL_SERVER" -U "$env:SQL_USERNAME" -P "$env:SQL_PASSWORD" -d AutoTest -Q "CREATE PROCEDURE InsertUser @Name NVARCHAR(100), @Surname NVARCHAR(100), @Email NVARCHAR(100) AS BEGIN INSERT INTO [user] (Name, Surname, Email) VALUES (@Name, @Surname, @Email) END"
        sqlcmd -S "$env:SQL_SERVER" -U "$env:SQL_USERNAME" -P "$env:SQL_PASSWORD" -d AutoTest -Q "EXEC InsertUser 'John', 'Doe', 'john.doe@example.com'"
        sqlcmd -S "$env:SQL_SERVER" -U "$env:SQL_USERNAME" -P "$env:SQL_PASSWORD" -d AutoTest -Q "EXEC InsertUser 'Jane', 'Smith', 'jane.smith@example.com'"
