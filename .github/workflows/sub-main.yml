name: Full SSIS Deployment

on:
  workflow_dispatch:

jobs:

  deploy-ssis-project:
    name: Deploy SSIS Project
    runs-on: [self-hosted, windows]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy SSIS Project (.ispac)
        env:
          SQL_SERVER2: ${{ secrets.SQL_SERVER2 }}
        shell: powershell
        run: |
          echo "Deploying SSIS project..."
          $ispacPath = "sc_PaballoPholo_2025\HandsOnProjects\Timesheets\bin\Development\Timesheets.ispac"
          Write-Host "Current working directory: $(Get-Location)"
          Write-Host "Checking ISPAC at path: $ispacPath"
          if (!(Test-Path $ispacPath)) {
            Write-Error "ISPAC file not found at $ispacPath"
            exit 1
          }
          $deployArgs = @(
            "/Silent",
            "/SourcePath:`"$ispacPath`"",
            "/DestinationServer:`"$env:SQL_SERVER2`"",
            "/DestinationPath:""/SSISDB/MyPackageDemos/TimeSheet"""
          )
          $process = Start-Process `
            -FilePath "C:\Program Files (x86)\Microsoft SQL Server\160\DTS\Binn\ISDeploymentWizard.exe" `
            -ArgumentList $deployArgs `
            -Wait `
            -PassThru `
            -NoNewWindow
          if ($process.ExitCode -ne 0) {
            Write-Error "Deployment failed with exit code $($process.ExitCode)"
            exit $process.ExitCode
          }
          echo "SSIS project deployed successfully."

  create-and-run-agent-job:
    name: Create and Run SQL Server Agent Job
    needs: deploy-ssis-project
    runs-on: [self-hosted, windows]

    steps: 
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run PowerShell script to create and start SQL Server Agent Job
        env:
          SQL_SERVER2: ${{ secrets.SQL_SERVER2 }}
          SQL_USERNAME: ${{ secrets.SQL_USERNAME }}
          SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          # Create job and steps
          .\Timesheet\SqlScripts\create_jobs.ps1 `
            -SqlServer $env:SQL_SERVER2 `
            -Username $env:SQL_USERNAME `
            -Password $env:SQL_PASSWORD

          # Start the job immediately
          sqlcmd -S $env:SQL_SERVER2 -U $env:SQL_USERNAME -P $env:SQL_PASSWORD -Q "EXEC msdb.dbo.sp_start_job N'TimesheetProjectRun';"

          echo "SQL Server Agent Job triggered."
